name: CI/CD Main Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - src/auth-service
          - src/ingestion-service
          - src/plots-service
          - src/sensor-service

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Build Docker image
      run: |
        cd ${{ matrix.service }}
        docker build -t myorg/${{ matrix.service }}:latest .

    - name: Run tests (health check)
      run: |
        cd ${{ matrix.service }}

        # Detecta puerto segÃºn el servicio
        if [[ "${{ matrix.service }}" == "src/sensor-service" ]]; then
          PORT=5003
        elif [[ "${{ matrix.service }}" == "src/plots-service" ]]; then
          PORT=5002
        elif [[ "${{ matrix.service }}" == "src/ingestion-service" ]]; then
          PORT=5001
        else
          PORT=5000
        fi

        echo "ðŸ§ª Iniciando test en puerto $PORT para ${{ matrix.service }}"

        docker run -d --name test-${{ matrix.service }} -p $PORT:$PORT myorg/${{ matrix.service }}:latest
        sleep 6
        curl -f http://localhost:$PORT/health || (docker logs test-${{ matrix.service }} && exit 1)
        docker stop test-${{ matrix.service }}

    - name: Deploy to Render
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      run: |
        # Detecta ID de Render segÃºn el servicio
        if [[ "${{ matrix.service }}" == "src/auth-service" ]]; then
          SERVICE_ID="srv-d3rdjtjipnbc73a7j7f0"
        elif [[ "${{ matrix.service }}" == "src/ingestion-service" ]]; then
          SERVICE_ID="srv-d3rdorbipnbc739hfkgg"
        elif [[ "${{ matrix.service }}" == "src/plots-service" ]]; then
          SERVICE_ID="srv-d3rdma0dl3ps73fahbn0"
        elif [[ "${{ matrix.service }}" == "src/sensor-service" ]]; then
          SERVICE_ID="srv-d3rdpq8dl3ps73fak0gg"
        else
          echo "Servicio desconocido"; exit 1
        fi

        echo "ðŸš€ Desplegando ${{ matrix.service }} en Render (ID: $SERVICE_ID)"
        curl -X POST "https://api.render.com/deploy/$SERVICE_ID" \
          -H "Authorization: Bearer $RENDER_API_KEY"
