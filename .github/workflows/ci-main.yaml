name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy-microservices:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth-service, ingestion-service, plots-service, sensor-service]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Health check before deploy
        run: |
          echo "Skipping Docker build, deploying directly to Render"

      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          if [ "${{ matrix.service }}" == "auth-service" ]; then
            curl -X POST https://api.render.com/deploy/srv-d3rdjtjipnbc73a7j7f0 \
            -H "Authorization: Bearer $RENDER_API_KEY"
          elif [ "${{ matrix.service }}" == "ingestion-service" ]; then
            curl -X POST https://api.render.com/deploy/srv-d3rdorbipnbc739hfkgg \
            -H "Authorization: Bearer $RENDER_API_KEY"
          elif [ "${{ matrix.service }}" == "plots-service" ]; then
            curl -X POST https://api.render.com/deploy/srv-d3rdma0dl3ps73fahbn0 \
            -H "Authorization: Bearer $RENDER_API_KEY"
          elif [ "${{ matrix.service }}" == "sensor-service" ]; then
            curl -X POST https://api.render.com/deploy/srv-d3rdpq8dl3ps73fak0gg \
            -H "Authorization: Bearer $RENDER_API_KEY"
          fi
